name: Android CI/CD

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        cache-read-only: false
        gradle-home-cache-cleanup: true
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Cache Gradle wrapper
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/wrapper
          ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Build with Gradle
      run: ./gradlew build --parallel --build-cache --configuration-cache
      
    - name: Run tests
      run: ./gradlew test --parallel --build-cache
      continue-on-error: true
      
    - name: Build Release APK
      run: ./gradlew assembleRelease --parallel --build-cache
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: yunduanban-app-release
        path: app/build/outputs/apk/release/*.apk
        retention-days: 30
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        cache-read-only: false
        gradle-home-cache-cleanup: true
    
    - name: Cache Gradle wrapper
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/wrapper
          ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build Release APK
      run: ./gradlew assembleRelease --parallel --build-cache --configuration-cache
      
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Rename APK
      run: |
        cd app/build/outputs/apk/release
        APK_FILE=$(ls -1 *.apk | head -1)
        mv "$APK_FILE" yunduanban-assistant-${{ steps.get_version.outputs.VERSION }}.apk
      
    - name: Create Release and Upload APK
      uses: softprops/action-gh-release@v1
      with:
        name: äº‘ç«¯åŠå°åŠ©æ‰‹ ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        body: |
          ## äº‘ç«¯åŠå°åŠ©æ‰‹ ${{ steps.get_version.outputs.VERSION }}
          
          ### æ–°å¢åŠŸèƒ½ âœ¨
          - ğŸ¤– **è‡ªåŠ¨åŒ–æ‰§æ³•æµç¨‹**ï¼šè‡ªåŠ¨å¤„ç†æ”¿åŠ¡å¾®ä¿¡å’Œé»„ç›¾æ‰§æ³•ä»»åŠ¡
          - ğŸ‘® **æ°‘è­¦é€‰æ‹©**ï¼šæ”¯æŒå¤šæ°‘è­¦å¿«é€Ÿåˆ‡æ¢
          - ğŸ“‹ **è½¦ç‰Œå¯¼å‡º**ï¼šä¸€é”®å¯¼å‡ºå¤„ç†è¿‡çš„è½¦ç‰Œä¿¡æ¯
          - ğŸ”„ **æ™ºèƒ½å¾ªç¯**ï¼šè‡ªåŠ¨å¤„ç†å¤šæ¡è¿æ³•è®°å½•
          - âš¡ **é”™è¯¯å¤„ç†**ï¼šæ™ºèƒ½å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
          
          ### æ ¸å¿ƒç‰¹æ€§ ğŸ¯
          - ğŸ”§ æ— éšœç¢æœåŠ¡è‡ªåŠ¨åŒ–
          - ğŸ“± æ”¿åŠ¡å¾®ä¿¡æ¶ˆæ¯å¤„ç†
          - ğŸš— è¿æ³•è½¦è¾†ä¿¡æ¯è¯†åˆ«
          - ğŸ“ è‡ªåŠ¨å¼€å•æµç¨‹
          - ğŸ—‘ï¸ è‡ªåŠ¨æ¸…ç†å¾®ä¿¡æ¶ˆæ¯
          - âœ… æ”¯æŒ Android 10+
          
          ### ä½¿ç”¨è¯´æ˜ ğŸ“–
          1. å…ˆç™»å½•[é»„ç›¾]ï¼Œåè¿›å…¥[æ‰§æ³•å¤„ç†]æ¨¡å—ï¼Œç‚¹å‡»[äº‘ç«¯åŠ]
          2. æ‰“å¼€[æ”¿åŠ¡å¾®ä¿¡]ï¼Œæ‰¾åˆ°ä»ç½‘é¡µç«¯è½¬å‘è¿‡æ¥çš„ä¿¡æ¯
          3. å‰å¾€[è®¾ç½®-æ— éšœç¢]å¼€å¯æ— éšœç¢æœåŠ¡
          4. ç‚¹å‡»[å¼€å§‹è¿è¡Œ]æŒ‰é’®å¯åŠ¨ç¨‹åº
          5. å®Œæˆåç‚¹å‡»[å¯¼å‡ºè½¦ç‰Œ]å¤åˆ¶å·²å¼€å•æ•°æ®
          6. æŒ‰éŸ³é‡ä¸Šé”®å¯æå‰ç»ˆæ­¢è¿è¡Œ
          
          ### å®‰è£…è¯´æ˜ ğŸ“¥
          1. ä¸‹è½½ `yunduanban-assistant-${{ steps.get_version.outputs.VERSION }}.apk`
          2. åœ¨ Android è®¾å¤‡ä¸Šå®‰è£…ï¼ˆéœ€å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨ï¼‰
          3. æˆäºˆæ— éšœç¢æœåŠ¡æƒé™
          4. å¼€å§‹ä½¿ç”¨ï¼
          
          ### ç³»ç»Ÿè¦æ±‚ ğŸ“±
          - Android 10.0 (API 29) åŠä»¥ä¸Š
          - æ— éšœç¢æœåŠ¡æƒé™
          - æ‚¬æµ®çª—æƒé™
          - å·²å®‰è£…æ”¿åŠ¡å¾®ä¿¡
          
          ### å¼€å‘è€… ğŸ‘¨â€ğŸ’»
          YUWEI@æ–°è´¨æˆ˜æ–—åŠ›æœªæ¥ä¸­å¿ƒ
          
          ---
          
          Â© 2025 æ–°è´¨æˆ˜æ–—åŠ›æœªæ¥ä¸­å¿ƒ
        files: |
          app/build/outputs/apk/release/yunduanban-assistant-${{ steps.get_version.outputs.VERSION }}.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
