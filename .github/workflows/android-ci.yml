name: Android CI/CD

on:
  push:
    # branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Cache Android SDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.android/build-cache
          ~/.android/cache
        key: ${{ runner.os }}-android-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-android-
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.2'
        cache-read-only: false
        cache-write-only: ${{ github.ref == 'refs/heads/main' }}
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Cache or Generate Keystore
      id: keystore
      run: |
        if [ ! -f keystore/debug.keystore ]; then
          mkdir -p keystore
          keytool -genkeypair -v -keystore keystore/debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"
          echo "generated=true" >> $GITHUB_OUTPUT
        else
          echo "generated=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Build Release APK (with tests)
      run: ./gradlew assembleRelease testReleaseUnitTest --parallel --build-cache --configuration-cache --daemon
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: yunduanban-app-release
        path: app/build/outputs/apk/release/*.apk
        retention-days: 30
    
    - name: Upload Keystore artifact
      if: steps.keystore.outputs.generated == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: keystore
        path: keystore/debug.keystore
        retention-days: 1
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: Download APK artifact
      uses: actions/download-artifact@v4
      with:
        name: yunduanban-app-release
        path: apk/
      
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Rename APK
      run: |
        cd apk
        APK_FILE=$(ls -1 *.apk | head -1)
        mv "$APK_FILE" yunduanban-assistant-${{ steps.get_version.outputs.VERSION }}.apk
      
    - name: Create Release and Upload APK
      uses: softprops/action-gh-release@v1
      with:
        name: 云端办小助手 ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        body: |
          ## 云端办小助手 ${{ steps.get_version.outputs.VERSION }}
          
          ### 新增功能 ✨
          - 🤖 **自动化执法流程**：自动处理政务微信和黄盾执法任务
          - 👮 **民警选择**：支持多民警快速切换
          - 📋 **车牌导出**：一键导出处理过的车牌信息
          - 🔄 **智能循环**：自动处理多条违法记录
          - ⚡ **错误处理**：智能处理各种异常情况
          
          ### 核心特性 🎯
          - 🔧 无障碍服务自动化
          - 📱 政务微信消息处理
          - 🚗 违法车辆信息识别
          - 📝 自动开单流程
          - 🗑️ 自动清理微信消息
          - ✅ 支持 Android 10+
          
          ### 使用说明 📖
          1. 先登录[黄盾]，后进入[执法处理]模块，点击[云端办]
          2. 打开[政务微信]，找到从网页端转发过来的信息
          3. 前往[设置-无障碍]开启无障碍服务
          4. 点击[开始运行]按钮启动程序
          5. 完成后点击[导出车牌]复制已开单数据
          6. 按音量上键可提前终止运行
          
          ### 安装说明 📥
          1. 下载 `yunduanban-assistant-${{ steps.get_version.outputs.VERSION }}.apk`
          2. 在 Android 设备上安装（需允许安装未知来源应用）
          3. 授予无障碍服务权限
          4. 开始使用！
          
          ### 系统要求 📱
          - Android 10.0 (API 29) 及以上
          - 无障碍服务权限
          - 悬浮窗权限
          - 已安装政务微信
          
          ### 开发者 👨‍💻
          YUWEI@新质战斗力未来中心
          
          ---
          
          © 2025 新质战斗力未来中心
        files: |
          apk/yunduanban-assistant-${{ steps.get_version.outputs.VERSION }}.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
